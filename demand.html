<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./css/font.css">
    <link rel="stylesheet" href="./css/xadmin.css">
    <script type="text/javascript" src="./js/jquery-2.1.0.js"></script>
    <script src="./lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="./js/Global.js"></script>
    <style>
        .wrap {
            padding: 20px;
            width: 100%;
            overflow: auto;
            box-sizing: border-box;
            min-height: 600px;
        }

        .select {
            height: 40px;
            padding: 20px 0;
            border-bottom: 1px solid #ccc;
            text-align: center;
        }

        .search {
            width: 200px;
            height: 38px;
            margin: 0 auto;
            display: inline-block;
            padding-top: 1px;

        }

        select {
            height: 36px;
            min-width: 80px;
        }

        .layui-input {
            /* border: 0; */
            outline: none;
        }

        .btn {
            display: inline-block;

        }

        .next {
            text-align: center;
        }

        .layui-table td,
        .layui-table th {
            padding: 0;
            text-align: center;
            height: 36px;
            line-height: 36px;
            font-size: 14px;
        }

        .hanf {
            width: 49%;
        }

        .layui-input-block {
            margin-left: 0px;
            padding: 0 5px;
        }

        .control {
            min-width: 110px;
        }

        .num {
            min-width: 50px;
        }

        .top-nav {
            font-size: 14px;
            list-style: none;
            position: relative;
            display: none;
        }

        .top-nav li {
            float: left;
            list-style: none;
            margin-right: 1px;
        }

        .top-nav li a {
            height: 40px;
            line-height: 40px;
            text-decoration: none;
            background: #ccc;
            color: #666666;
            display: block;
            width: 200px;
            text-align: center;
        }

        .top-nav li a:hover {
            background: #666;
            color: #FFF;
        }

        .top-nav ul {
            list-style: none;
            display: none;
            width: 200px;
            padding: 0;
            position: relative;
        }

        .top-nav li ul {
            position: absolute;
            top: 0;
            left: 200px;
        }

        .layui-form {
            display: inline-block;
            margin: 0;
            padding: 0;
            height: 24px;
        }

        .search {
            width: 200px;
            height: 38px;
            margin: 0 auto;
            display: inline-block;
            padding-top: 1px;

        }

        .search .layui-input {
            width: 200px;
            border: 1px solid #ccc;
        }

        .winbody,.addwin {
            width: 1200px;
            padding: 10px;
            display: none;
            min-height: 400px;
        }
        .ddh {
            width: 180px;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="search">
            <input class="layui-input ksdate" type="text" placeholder="开始日期">
        </div>
        <div class="layui-form">
            <div class="layui-form-item">
                <div class="layui-input-inline">
                    <select lay-filter="datesel" name="quiz2">
                        <option value="">请选时段</option>
                        <option value="0">一季度</option>
                        <option value="1">二季度</option>
                        <option value="2">三季度</option>
                        <option value="3">四季度</option>
                        <option value="4">上半年</option>
                        <option value="5">下半年</option>
                        <option value="6">本年度</option>
                        <option value="7">上年度</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="search">
            <input class="layui-input jsdate" type="text" placeholder="结束日期">
        </div>
        <div class="btn">
            <button class="layui-btn layui-btn-normal" onclick="sel()">查询</button>
        </div>
        <div style="margin:10px 0;"><button class="layui-btn layui-btn-normal" onclick="addPlan()">新增</button> </div>
        <table class="layui-table" lay-filter="table">
            <thead>
                <tr>
                    <th width="5%" class="num">序号</th>
                    <th width="10%">日期</th>
                    <th width="20%">单位</th>
                    <th width="5%">业务经理</th>
                    <th width="10%">品名</th>
                    <th width="10%">品牌</th>
                    <th width="10%">规格</th>
                    <th width="10%">型号</th>
                    <th width="10%">产地</th>
                    <th width="5%">单位</th>
                    <th width="5%">需求量</th>
                    <th class="control">操作</th>
                </tr>
            </thead>
            <tbody class="dlists">

            </tbody>
        </table>
    </div>
    <div class="winbody">
        <div class="layui-btn layui-btn-xs" onclick="addList()">新增</div>
        <table class="layui-table">
            <tbody class="dbody">

            </tbody>
        </table>
    </div>
    <div class="addwin">
            <div class="layui-btn layui-btn-xs" onclick="adwinaddList()">新增</div>
            <table class="layui-table" id="add" lay-filter="table">
        <tr class="addinfos">
                    <td>日期</td>
                    <td><input type="text" class="layui-input adddate" data-name="dt" value="">
                        <input type="hidden" data-name="id" value=""> 
                        <input type="hidden" data-name="wordState" value="">
                        </td>
                    <td>业务经理</td>
                    <td><input type="text" class="layui-input" id="ye" data-name="bManager" value=""></td>
                    <td>上报部门</td>
                    <td colspan="2"><input type="text" class="layui-input" data-name="grounp" value=""></td>
                    <td>订单号</td>
                    <td class="ddh"><input type="text" class="layui-input" id="sheetId" readonly data-name="sheetId" value=""></td>
                </tr>
                <tr>
                    <td>品名</td>
                    <td>品牌</td>
                    <td>规格</td>
                    <td>型号</td>
                    <td>产地</td>
                    <td>物料新旧</td>
                    <td>单位</td>
                    <td>需求数量</td>
                    <td>备注</td>
                </tr>

                </table>
    </div>
</body>
<script>
    


    layui.use('laydate', function () {
        var laydate = layui.laydate;

        //执行一个laydate实例
        laydate.render({
            elem: '.ksdate' //指定元素
        });
        laydate.render({
            elem: '.jsdate' //指定元素
        });
        laydate.render({
            elem:'.adddate',
            done: function (val) {
                $.ajax({
                url:`${API}/erpOrderd/selectSheetId`,
                type:'post',
                data:{
                    time: val
                },
                success: function (res) {
                    console.log(res,'666')
                    $('#sheetId').val(res.data)
                }
            })
            }
        })
    });
    // 设置当前月
    var date_c = new Date();
    var year_c = date_c.getFullYear();
    var month_c = date_c.getMonth() + 1;
    let addCount = 0
    switch (month_c){
    	case 1:
    	case 3:
    	case 5:
    	case 7:
    	case 8:
    	case 10:
    	case 12:
    		$('.ksdate').val(year_c + '-' + month_c + '-1');
    		$('.jsdate').val(year_c + '-' + month_c + '-31');
    		break;
    	case 4:
    	case 6:
    	case 9:
    	case 11:
    		$('.ksdate').val(year_c + '-' + month_c + '-1');
    		$('.jsdate').val(year_c + '-' + month_c + '-30');
    		break;
    	case 2:
    		$('.ksdate').val(year_c + '-' + month_c + '-1');
    		$('.jsdate').val(year_c % 4 ==0 && year_c % 100 != 0 ? year_c + '-' + month_c + '-29' : year_c + '-' + month_c + '-28');
    		break;
    	default:
    		break;
    }
    layui.use('form', function () {
        var form = layui.form
        form.on('select(datesel)', function (data) {
            let val = data.value
            let years = new Date().getFullYear()
            switch (val) {
                case '0':
                    $('.ksdate').val(`${years}-01-01`)
                    $('.jsdate').val(`${years}-03-31`)
                    break;
                case '1':
                    $('.ksdate').val(`${years}-04-01`)
                    $('.jsdate').val(`${years}-06-30`)
                    break;
                case '2':
                    $('.ksdate').val(`${years}-07-01`)
                    $('.jsdate').val(`${years}-09-30`)
                    break;
                case '3':
                    $('.ksdate').val(`${years}-10-01`)
                    $('.jsdate').val(`${years}-12-31`)
                    break;
                case '4':
                    $('.ksdate').val(`${years}-01-01`)
                    $('.jsdate').val(`${years}-06-30`)
                    break;
                case '5':
                    $('.ksdate').val(`${years}-07-01`)
                    $('.jsdate').val(`${years}-12-31`)
                    break;
                case '6':
                    $('.ksdate').val(`${years}-01-01`)
                    $('.jsdate').val(`${years}-12-31`)
                    break;
                case '7':
                    $('.ksdate').val(`${years - 1}-01-01`)
                    $('.jsdate').val(`${years - 1}-12-31`)
                    break;
            }
        });
    })
    let arr = []
    sel()
    function sel () {
        let demand = {
        custId: loadUserInfo.customer.id,
        startTime: $('.ksdate').val(),
        endTime: $('.jsdate').val()
    }
    
    $.ajax({
        url: `${API}/erpOrderd/selectOrderByTime`,
        type: 'post',
        data: demand,
        success: function (res) {
            arr = res.data.reverse()
            let str = ''
            $.each(arr, function (i, json) {
                str += `<tr>
                    <td>${arr.length - i}<input type="hidden" data-name="id" value="${json.id}">
                        <input type="hidden" data-name="wordState" value="${json.wordState}">
                    </td>
                    <td>
                       ${json.dt || ''}
                    </td>
                    <td>
                       ${json.cus_name || ''}
                    </td>
                    <td>
                       ${json.b_manager || ''}
                    </td><td>
                       ${json.materiel_name || ''}
                    </td>
                    <td>
                       ${json.materiel_brand || ''}
                    </td>
                    <td>
                        ${json.materiel_Specifications || ''}
                    </td>
                    <td>
                        ${json.materiel_model || ''}
                    </td>
                    <td>
                       ${json.materiel_place || ''}
                    </td>
                    <td>
                        ${json.materiel_unit || ''}
                    </td>
                    <td>
                       ${json.materiel_amount || ''}
                    </td>
              <td>
                        <button class="layui-btn  layui-btn-sm" onclick="update('${json.order_id}','${i}')">修改</button> <button class="layui-btn layui-btn-danger layui-btn-sm" onclick="del(${json.id})">删除</button>
                    </td>
                </tr>`
            })
            $('.dlists').html(str)

        }
    })
    }

    // 修改
    function update(id,i) {
        $.ajax({
            url:`${API}/erpOrderd/selectByOrderId?orderId=${id}`,
            type:'get',
            success: function (res) {
                let json = res.data
                let str = ''
        str += `<tr class="infos">
                    <td>日期</td>
                    <td><input type="text" class="layui-input xgdate" data-name="dt" value="${json.order.dt}">
                        <input type="hidden" data-name="id" value="${json.order.id}"> 
                        <input type="hidden" data-name="wordState" value="${json.order.wordState}">
                        </td>
                    <td>业务经理</td>
                    <td><input type="text" class="layui-input" data-name="bManager" value="${json.order.bManager}"></td>
                    <td>上报部门</td>
                    <td colspan="2"><input type="text" class="layui-input" data-name="grounp" value="${json.order.grounp}"></td>
                    <td>订单号</td>
                    <td class="ddh"><input type="text" class="layui-input" readonly data-name="sheetId" value="${json.order.sheetId}"></td>
                </tr>
                <tr>
                    <td>品名</td>
                    <td>品牌</td>
                    <td>规格</td>
                    <td>型号</td>
                    <td>产地</td>
                    <td>物料新旧</td>
                    <td>单位</td>
                    <td>需求数量</td>
                    <td>备注</td>
                </tr>`
            
        let list = res.data.materielList.reverse()
        $.each(list,function (j,n) {
            str += `<tr class="mlist sss_${i}"><td >
                    <input type="hidden" data-name="id" value="${n.id}">
                    <input type="hidden" data-name="workState" value="${n.workState}">
                        <input type="text" class="layui-input" data-name="materielName" value="${n.materielName}">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielBrand" value="${n.materielBrand}">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielSpecifications" value="${n.materielSpecifications}">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielModel" value="${n.materielModel}">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielPlace" value="${n.materielPlace}">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielState" value="${n.materielState}">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielUnit" value="${n.materielUnit}">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielAmount" value="${n.materielAmount}">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="remark" value="${n.remark}">
                    </td></tr>`
        })
        $('.dbody').html(str)
        layui.use('laydate',function () {
            layui.laydate.render({
                elem:'.xgdate'
            })
        })
        layui.use('layer', function () {
            let layer = layui.layer
            layer.open({
                type: 1,
                title: '修改',
                content: $('.winbody'),
                area: ['1220px'],
                btn: ['保存', '取消'],
                yes: function (index) {
                    layer.close(index)
                    let saveData = {}
                    let list = []
                    $(`.sss_${i}`).each(function () {
                        let data = {}
                        $(this).find('input').each(function () {
                            data[$(this).data('name')] = $(this).val()
                        })
                        list.push(data)
                    })
                    $('.infos input').each(function () {
                        saveData[$(this).data('name')] = $(this).val()
                    })
                    saveData.customerId = loadUserInfo.customer.id
                    saveData.json = JSON.stringify(list)
                    $.ajax({
                        url:`${API}/erpOrderd/addOrderd`,
                        data:saveData,
                        type:'post',
                        success: function (res) {
                            if(res.code == 0) {
                                sel()
                                layer.msg('保存成功!')
                            }
                        }
                    })
                    
                }
            })
        })
    }
    })
}
    let adaddcount = 0
    function adwinaddList () {
        adaddcount++
        $('#add').append(`
        <tr class="mlist list_${adaddcount}"><td>
                        <input type="hidden" data-name="id"  value="0">
                        <input type="hidden" data-name="workState"  value="0">
                        <input type="hidden" data-name="bManager"  value="${loadUserInfo.user.realName}">
                        
                        <input type="text" class="layui-input" data-name="materielName" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielBrand" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielSpecifications" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielModel" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielPlace" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielState" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielUnit" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielAmount" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="remark" value="">
                    </td></tr>
        `) 
        
    }
    adwinaddList()
    // 增加需求计划
    function addPlan () {
    	$("#ye").val(loadUserInfo.user.realName);
        let layer = ''
        let form = ''
        layui.use('layer',function () {
            layer = layui.layer
            form = layui.form
        })
        $('.adddate').on('blur',function () {
            
        })
        layer.open({
            type:1,
            title:'新增',
            content:$('.addwin'),
            area: ['1220px'],
            btn: ['保存', '取消'],
            yes:function (index) {
                let saveData = {}
                    let list = []
                    $(`.list_${adaddcount}`).each(function () {
                        let data = {}
                        $(this).find('input').each(function () {
                            data[$(this).data('name')] = $(this).val()
                        })
                        list.push(data)
                    })
                    $('.addinfos input').each(function () {
                        saveData[$(this).data('name')] = $(this).val()
                    })
                    saveData.customerId = loadUserInfo.customer.id
                    saveData.json = JSON.stringify(list)
                    $.ajax({
                        url:`${API}/erpOrderd/addOrderd`,
                        data:saveData,
                        type:'post',
                        success: function (res) {
                            if(res.code == 0) {
                                sel()
                                layer.msg('保存成功!')
                            }
                        }
                    }) 
            }
        })
    }
    
    // 增加需求物料
    function addList () {
        $('.dbody').append(`
        <tr class="mlist list_${addCount}"><td>
                        <input type="hidden" data-name="id"  value="0">
                        <input type="hidden" data-name="workState"  value="0">
                        <input type="text" class="layui-input" data-name="materielName" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielBrand" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielSpecifications" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielModel" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielPlace" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielState" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielUnit" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="materielAmount" value="">
                    </td>
                    <td>
                        <input type="text" class="layui-input" data-name="remark" value="">
                    </td></tr>
        `) 
        addCount++
    }
    // 删除
    function del(id) {
        if (confirm('是否删除?')) {
            $.ajax({
                url: `${API}/erpOrderd/removeOrderdById?orderId=${id}`,
                type: 'get',
                success: function (res) {
                    console.log(res)
                    window.location.reload()
                }
            })
        }
    }
</script>